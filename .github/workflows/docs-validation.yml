name: ğŸ“š Documentation Validation

on:
  push:
    branches: [ main, mintlify ]
  pull_request:
    branches: [ main, mintlify ]
  workflow_dispatch:

jobs:
  validate-docs:
    name: ğŸ” Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: ğŸ”§ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Install Node dependencies
        run: |
          npm install -g markdownlint-cli2


      - name: ğŸ—ï¸ Validate docs.json structure
        run: |
          echo "::group::ğŸ” Validating docs.json and redirects"
          python3 .scripts/validate-redirects.py
          echo "::endgroup::"


      - name: ğŸ”— Check internal links
        run: |
          echo "::group::ğŸ”— Checking internal links"
          mkdir -p tmp
          python3 .scripts/extract_links.py
          python3 .scripts/check_links.py
          echo "::endgroup::"

      - name: âœ¨ Lint Markdown files
        run: |
          echo "::group::âœ¨ Linting Markdown files"
          markdownlint-cli2 --config .markdownlint.yaml "**/*.{md,mdx}" || true
          echo "::endgroup::"

      - name: ğŸ“Š Generate validation report
        if: always()
        run: |
          echo "## ğŸ“š Documentation Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Validation Steps Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- docs.json structure and redirects" >> $GITHUB_STEP_SUMMARY
          echo "- Internal links verification" >> $GITHUB_STEP_SUMMARY
          echo "- Markdown linting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ˆ Statistics:" >> $GITHUB_STEP_SUMMARY
          echo "- **MDX Files**: $(find . -name '*.mdx' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Navigation Pages**: $(python3 -c 'import json; config=json.load(open("docs.json")); print("N/A - see logs for count")')" >> $GITHUB_STEP_SUMMARY
          echo "- **Redirects**: $(python3 -c 'import json; config=json.load(open("docs.json")); print(len(config.get("redirects", [])))')" >> $GITHUB_STEP_SUMMARY

  # Optional: Test production redirects (only on main branch)
  test-production-redirects:
    name: ğŸŒ Test Production Redirects
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: validate-docs

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: ğŸ§ª Test redirects against production
        run: |
          echo "::group::ğŸŒ Testing production redirects"
          if [ -f .scripts/test-redirects.py ]; then
            python3 .scripts/test-redirects.py || true
          else
            echo "Production redirect test script not found, skipping..."
          fi
          echo "::endgroup::"
